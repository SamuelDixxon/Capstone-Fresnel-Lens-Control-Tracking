<html>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-auth-compat.js"></script>
    <script src="joy.js"></script>

    <!-- <script type="module">
        import apprun from './index.js';
        window.apprun = apprun;
    </script>
    <script>
        window.onload = () => {
            apprun();
        }
    </script> -->

    <center>
        <h1>Heliostat Controls Web Data</h1>

        <!-- Three buttons in a group -->
        <div class="btn-group" style="width:100%">
            <button style="width:25%" value="off" id="b1" onclick="build_table()">Data Query and Table</button>
            <button style="width:25%" value="off" id="b2" onclick="build_graph()">Historical Capture</button>
            <button style="width:25%" value="off" id="b3" onclick="build_control()">Manual Control</button>
            <button style="width:25%" value="off" id="b4" onclick="build()">Buildable</button>
        </div>


        <script>

            function sleep(milliseconds) {
                // sleep method in milliseconds to include delay in code
                // Get the current data
                const date = Date.now();
                let currentDate = null;
                // do while loop to allow delay to happen until parameter
                // milliseconds is achieved
                do {
                    currentDate = Date.now();
                } while (currentDate - date < milliseconds);
            }

            function build_table() {

                var b1 = document.getElementById('b1').value;
                var b2 = document.getElementById('b2').value;
                var b3 = document.getElementById('b3').value;
                var b4 = document.getElementById('b4').value;

                if (b1 == "off" & b4 == "off") {

                    if (b2 == "on") {
                        var table = document.getElementById('tbl');
                        table.replaceChildren();
                        table.remove();
                        document.getElementById('b2').value = 'off';
                    }

                    if (b3 == "on") {
                        var joystick = document.getElementById('joyDiv');
                        joystick.remove();
                        document.getElementById('b3').value = 'off';
                    }

                    google.load('visualization', '1.1', { packages: ['controls'] });
                    google.charts.load('current', { 'packages': ['corechart'] });
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', 'https://kcze3io03f.execute-api.us-east-2.amazonaws.com/default/testing123');
                    xhr.responseType = 'json';
                    xhr.send();
                    var rows = [];
                    xhr.onreadystatechange = (e) => {

                        var jsondat = xhr.response;
                        if (jsondat != null) {
                            if (Object.keys(jsondat).length > 0) {
                                Object.keys(jsondat).forEach(function (key) {
                                    var jsondatnest = jsondat[key];
                                    var row = [];
                                    Object.keys(jsondatnest).forEach(function (key1) {
                                        row.push(jsondatnest[key1]);
                                    });
                                    rows.push(row);
                                });
                            };

                            var data = new google.visualization.DataTable();
                            data.addColumn('string', 'Sensor');
                            data.addColumn('number', 'Reading');
                            data.addColumn('number', 'Timestamp');
                            data.addRows(rows);


                            var string_filter = document.createElement('div');
                            string_filter.id = 'string_filter_div';
                            var number_filter = document.createElement('div');
                            number_filter.id = 'numnber_range_filter_div';
                            var table_div = document.createElement('div');
                            table_div.id = 'table_div';
                            var dash = document.createElement('div')
                            dash.id = 'dashboard';
                            dash.appendChild(string_filter);
                            dash.appendChild(number_filter);
                            dash.appendChild(table_div);
                            dash.style = 'margin-top:20px;margin:auto;';
                            string_filter.style = 'margin-top:20px;margin:auto;';
                            number_filter.style = 'margin-top:20px;margin:auto;';
                            table_div.style = 'margin-top:20px;margin:auto;';
                            document.getElementsByTagName('body')[0].appendChild(dash);


                            var dashboard = new google.visualization.Dashboard(document.querySelector('#dashboard'));

                            var stringFilter = new google.visualization.ControlWrapper({
                                controlType: 'StringFilter',
                                containerId: 'string_filter_div',
                                options: {
                                    filterColumnIndex: 0
                                }
                            });

                            var numberRangeFilter = new google.visualization.ControlWrapper({
                                controlType: 'NumberRangeFilter',
                                containerId: 'numnber_range_filter_div',
                                options: {
                                    filterColumnIndex: 2,
                                    minValue: 0,
                                    maxValue: 1000,
                                    ui: {
                                        label: 'Timestamp'
                                    }
                                }
                            });

                            var table = new google.visualization.ChartWrapper({
                                chartType: 'Table',
                                containerId: 'table_div',
                                options: {
                                    showRowNumber: true
                                }
                            });

                            dashboard.bind([stringFilter, numberRangeFilter], [table]);
                            dashboard.draw(data);
                        } else {
                            console.log("Null contents");
                        }
                    };

                    document.getElementById('b1').value = 'on';

                } else if (b1 == "off" & b4 == "on") {
                    google.load('visualization', '1.1', { packages: ['controls'] });
                    google.charts.load('current', { 'packages': ['corechart'] });
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', 'https://kcze3io03f.execute-api.us-east-2.amazonaws.com/default/testing123');
                    xhr.responseType = 'json';
                    xhr.send();
                    var rows = [];
                    xhr.onreadystatechange = (e) => {

                        var jsondat = xhr.response;
                        if (jsondat != null) {
                            if (Object.keys(jsondat).length > 0) {
                                Object.keys(jsondat).forEach(function (key) {
                                    var jsondatnest = jsondat[key];
                                    var row = [];
                                    Object.keys(jsondatnest).forEach(function (key1) {
                                        row.push(jsondatnest[key1]);
                                    });
                                    rows.push(row);
                                });
                            };

                            var data = new google.visualization.DataTable();
                            data.addColumn('string', 'Sensor');
                            data.addColumn('number', 'Reading');
                            data.addColumn('number', 'Timestamp');
                            data.addRows(rows);

                            var string_filter = document.createElement('div');
                            string_filter.id = 'string_filter_div';
                            var number_filter = document.createElement('div');
                            number_filter.id = 'numnber_range_filter_div';
                            var table_div = document.createElement('div');
                            table_div.id = 'table_div';
                            var dash = document.createElement('div')
                            dash.id = 'dashboard';
                            dash.className = 'dash';
                            dash.appendChild(string_filter);
                            dash.appendChild(number_filter);
                            dash.appendChild(table_div);
                            document.getElementsByTagName('body')[0].appendChild(dash);


                            var dashboard = new google.visualization.Dashboard(document.querySelector('#dashboard'));


                            var stringFilter = new google.visualization.ControlWrapper({
                                controlType: 'StringFilter',
                                containerId: 'string_filter_div',
                                options: {
                                    filterColumnIndex: 0
                                }
                            });

                            var numberRangeFilter = new google.visualization.ControlWrapper({
                                controlType: 'NumberRangeFilter',
                                containerId: 'numnber_range_filter_div',
                                options: {
                                    filterColumnIndex: 2,
                                    minValue: 0,
                                    maxValue: 1000,
                                    ui: {
                                        label: 'Timestamp'
                                    }
                                }
                            });

                            var table = new google.visualization.ChartWrapper({
                                chartType: 'Table',
                                containerId: 'table_div',
                                options: {
                                    showRowNumber: true
                                }
                            });

                            dashboard.bind([stringFilter, numberRangeFilter], [table]);
                            dashboard.draw(data);

                        } else {
                            console.log("Null contents");
                        }
                    };
                    document.getElementById('b1').value = 'on';
                } else {
                    document.getElementById('b1').value = 'off';
                }
            }

            function build_graph() {

                var b1 = document.getElementById('b1').value;
                var b2 = document.getElementById('b2').value;
                var b3 = document.getElementById('b3').value;
                var b4 = document.getElementById('b4').value;

                if (b2 == "off" & b4 == "off") {

                    if (b1 == "on") {
                        var table = document.getElementById('dashboard');
                        table.replaceChildren();
                        table.remove();
                        document.getElementById('b1').value = 'off'; // reset b1 button to off
                    }

                    if (b3 == "on") {
                        var joystick = document.getElementById('joyDiv');
                        joystick.remove();
                        document.getElementById('b3').value = 'off'; // reset b3 button to off
                    }

                    google.charts.load('current', { 'packages': ['corechart'] });
                    google.charts.setOnLoadCallback(draw_chart);
                    function draw_chart() {
                        var data = google.visualization.arrayToDataTable([
                            ['Time', 'Sensor'],
                            [8, 12],
                            [4, 5.5],
                            [11, 14],
                            [4, 5],
                            [3, 3.5],
                            [6.5, 7]
                        ]);

                        var options = {
                            title: 'Sensor Value Reading vs. Timestamp',
                            hAxis: { title: 'Time', minValue: 0, maxValue: 15 },
                            vAxis: { title: 'Sensor Value Reading', minValue: 0, maxValue: 15 },
                            legend: 'none',
                            width: 900,
                            height: 700

                        };


                        var tbl = document.createElement('table');
                        tbl.id = 'tbl';
                        tbl.className = 'columns';
                        var row = document.createElement('tr');
                        var cell1 = document.createElement('td');
                        var cell2 = document.createElement('td');
                        var graph1 = document.createElement('div');
                        graph1.id = 'chart_div1';
                        var graph2 = document.createElement('div');
                        graph2.id = 'chart_div2';
                        cell1.appendChild(graph1);
                        cell2.appendChild(graph2);
                        row.appendChild(cell1); row.appendChild(cell2);
                        tbl.appendChild(row);
                        document.getElementsByTagName('body')[0].appendChild(tbl);

                        var chart = new google.visualization.ScatterChart(document.getElementById('chart_div1'));
                        var chart2 = new google.visualization.ScatterChart(document.getElementById('chart_div2'))
                        chart.draw(data, options);
                        chart2.draw(data, options);
                        document.getElementById('b2').value = 'on';
                    }

                } else if (b2 == "off" & b4 == "on") {

                    google.charts.load('current', { 'packages': ['corechart'] });
                    google.charts.setOnLoadCallback(draw_chart);
                    function draw_chart() {
                        var data = google.visualization.arrayToDataTable([
                            ['Time', 'Sensor'],
                            [8, 12],
                            [4, 5.5],
                            [11, 14],
                            [4, 5],
                            [3, 3.5],
                            [6.5, 7]
                        ]);

                        var options = {
                            title: 'Sensor Value Reading vs. Timestamp',
                            hAxis: { title: 'Time', minValue: 0, maxValue: 15 },
                            vAxis: { title: 'Sensor Value Reading', minValue: 0, maxValue: 15 },
                            legend: 'none',
                            width: 900,
                            height: 700
                        };

                        var tbl = document.createElement('table');
                        tbl.id = 'tbl';
                        tbl.className = 'columns';
                        var row = document.createElement('tr');
                        var cell1 = document.createElement('td');
                        var cell2 = document.createElement('td');
                        var graph1 = document.createElement('div');
                        graph1.id = 'chart_div1';
                        var graph2 = document.createElement('div');
                        graph2.id = 'chart_div2';
                        cell1.appendChild(graph1);
                        cell2.appendChild(graph2);
                        row.appendChild(cell1); row.appendChild(cell2);
                        tbl.appendChild(row);
                        document.getElementsByTagName('body')[0].appendChild(tbl);

                        var chart = new google.visualization.ScatterChart(document.getElementById('chart_div1'));
                        var chart2 = new google.visualization.ScatterChart(document.getElementById('chart_div2'))
                        chart.draw(data, options);
                        chart2.draw(data, options);
                        document.getElementById('b2').value = 'on';

                    }
                } else {
                    document.getElementById('b2').value = 'off';
                }
            }

            function build_control() {
                var b1 = document.getElementById('b1').value;
                var b2 = document.getElementById('b2').value;
                var b3 = document.getElementById('b3').value;
                var b4 = document.getElementById('b4').value;
                if (b3 == 'off' & b4 == 'off') {
                    if (b1 == 'on') {
                        var table = document.getElementById('dashboard');
                        table.replaceChildren();
                        table.remove();
                        document.getElementById('b1').value = 'off'; // reset b1 button to off
                    }
                    if (b2 == 'on') {
                        var table = document.getElementById('tbl');
                        tbl.replaceChildren();
                        tbl.remove();
                        document.getElementById('b2').value = 'off';
                    }
                    var joystick = document.createElement('div')
                    joystick.id = 'joyDiv';
                    joystick.style = 'width:400px;height:400px;margin-bottom:20px;margin:auto;';
                    document.getElementsByTagName('body')[0].appendChild(joystick);
                    var joy = new JoyStick('joyDiv');
                    document.getElementById('b3').value = 'on';
                } else if (b3 == 'off' & b4 == 'on') {
                    var joystick = document.createElement('div')
                    joystick.id = 'joyDiv';
                    joystick.style = 'width:400px;height:400px;margin-bottom:20px;margin:auto;';
                    document.getElementsByTagName('body')[0].appendChild(joystick);
                    var joy = new JoyStick('joyDiv');
                    document.getElementById('b3').value = 'on';
                } else {
                    var joystick = document.getElementById('joyDiv');
                    document.getElementById('b3').value = 'off';
                }
            }
            function build() {
                var compose = document.getElementById('b4').value;
                if (compose == 'on') {
                    document.getElementById('b4').value = 'off';
                } else {
                    document.getElementById('b4').value = 'on';
                }
            }
        </script>

        <!-- <div id="dashboard">
            <div id="string_filter_div"></div>
            <div id="numnber_range_filter_div"></div>
            <div id="table_div"></div>
        </div> -->
        <!-- 
        <table class="columns">
            <col style="width: 50%;" />
            <col style="width: 50%;" />
            <tr>
                <td>
                    <div id="chart_div1" style="width: 100%"></div>
                </td>
                <td>
                    <div id="chart_div2" style="width: 100%"></div>
                </td>
            </tr>
        </table> -->
    </center>
</body>

</html>